<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>üé¨ Cinema Paradise Mobile v1.2-FRESH</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json?v=1.2">
    
    <!-- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫—ç—à–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow-x: hidden;
            height: 100vh;
            user-select: none;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .status-bar {
            height: 44px;
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-online {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }

        .status-offline {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #f44336;
        }

        .status-connecting {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid rgba(255, 152, 0, 0.5);
            color: #ff9800;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .feature-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.15);
        }

        .action-button {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-button:active {
            transform: scale(0.96);
            background: rgba(255, 255, 255, 0.25);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .movie-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .movie-card:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15);
        }

        .movie-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .movie-info {
            font-size: 13px;
            opacity: 0.8;
            line-height: 1.4;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 12px;
            z-index: 3000;
            font-weight: 600;
            text-align: center;
            transform: translateY(-100px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification.success {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }

        .notification.error {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
        }

        .nav-item.active {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .nav-item:active {
            transform: scale(0.9);
        }

        .nav-icon {
            font-size: 22px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .install-prompt {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .install-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
        }

        @media (max-height: 600px) {
            .header {
                padding: 15px;
            }
            .main-content {
                padding: 15px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        .booking-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .booking-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
        }

        .booking-header h3 {
            color: white;
            font-size: 22px;
            font-weight: 700;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .session-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .screen-indicator {
            text-align: center;
            margin-bottom: 25px;
        }

        .screen {
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            height: 8px;
            border-radius: 20px;
            margin-bottom: 8px;
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.3);
        }

        .screen-indicator p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .seat-map {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }

        .seat-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .row-number {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            width: 20px;
            text-align: center;
            font-weight: 600;
        }

        .seat {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seat.free {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .seat.free:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .seat.selected {
            background: #764ba2;
            color: white;
            border: 2px solid #8a5ac2;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(118, 75, 162, 0.5);
        }

        .seat.occupied {
            background: #f44336;
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .booking-legend {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .seat-demo {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .seat-demo.free {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .seat-demo.selected {
            background: #4CAF50;
        }

        .seat-demo.occupied {
            background: #f44336;
        }

        .booking-summary {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .booking-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="status-bar">
            üé¨ Cinema Paradise Mobile App
        </div>

        <div class="header">
            <h1>üé¨ Cinema Paradise</h1>
            <div id="connectionStatus" class="connection-status status-connecting">
                <span>üîÑ</span>
                <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
        </div>

        <div class="main-content">
            <!-- –≠–∫—Ä–∞–Ω —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
            <div id="installPrompt" class="install-prompt" style="display: none;">
                <h3>üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
                <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Cinema Paradise –Ω–∞ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞!</p>
                <button id="installButton" class="install-button">
                    üì• –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                </button>
            </div>

            <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
            <div id="homeScreen" class="screen active">
                <div class="feature-card">
                    <h3>üé≠ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–æ–º</h3>
                    <p>–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è Cinema Paradise</p>
                </div>

                <button class="action-button" onclick="testConnection()">
                    <span>üîó</span>
                    <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API</span>
                </button>
                
                <button class="action-button" onclick="loadDemoData()">
                    <span>üé≠</span>
                    <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ –¥–∞–Ω–Ω—ã–µ</span>
                </button>
                
                <button class="action-button" onclick="showMovies()">
                    <span>üé¨</span>
                    <span>–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∏–ª—å–º–æ–≤</span>
                </button>

                <button class="action-button" onclick="showSessions()">
                    <span>üïí</span>
                    <span>–°–µ–∞–Ω—Å—ã –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞</span>
                </button>
                
                <button class="action-button" onclick="showLogin()">
                    <span>üë§</span>
                    <span>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</span>
                </button>
                
                <button class="action-button" onclick="testAuthCompat()">
                    <span>üîó</span>
                    <span>–¢–µ—Å—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</span>
                </button>
            </div>

            <!-- –≠–∫—Ä–∞–Ω —Ñ–∏–ª—å–º–æ–≤ -->
            <div id="moviesScreen" class="screen">
                <h2>üé¨ –§–∏–ª—å–º—ã –≤ –ø—Ä–æ–∫–∞—Ç–µ</h2>
                <div id="moviesContainer" class="movies-grid"></div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω —Å–µ–∞–Ω—Å–æ–≤ -->
            <div id="sessionsScreen" class="screen">
                <h2>üïí –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ–∞–Ω—Å–æ–≤</h2>
                <div id="sessionsContainer"></div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
            <div id="loginScreen" class="screen">
                <div class="feature-card">
                    <h3>üë§ –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
                    <input type="text" id="loginUsername" placeholder="–õ–æ–≥–∏–Ω" style="width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
                    <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
                    <button class="action-button" onclick="performLogin()">
                        <span>üîê</span>
                        <span>–í–æ–π—Ç–∏</span>
                    </button>
                    <button class="action-button" onclick="logout()" style="background: rgba(244, 67, 54, 0.3); border-color: rgba(244, 67, 54, 0.5);">
                        <span>üö™</span>
                        <span>–í—ã–π—Ç–∏</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="notification" class="notification"></div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div id="bookingModal" class="booking-modal" style="display: none;">
            <div class="booking-content">
                <div class="booking-header">
                    <h3>üé´ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–∞</h3>
                    <button onclick="closeBookingModal()" class="close-button">√ó</button>
                </div>
                
                <div id="bookingSessionInfo" class="session-info"></div>
                
                <div class="screen-indicator">
                    <div class="screen"></div>
                    <p>–≠–ö–†–ê–ù</p>
                </div>
                
                <div id="seatMap" class="seat-map"></div>
                
                <div class="booking-legend">
                    <div class="legend-item">
                        <div class="seat-demo free"></div>
                        <span>–°–≤–æ–±–æ–¥–Ω–æ</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat-demo selected"></div>
                        <span>–í—ã–±—Ä–∞–Ω–æ</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat-demo occupied"></div>
                        <span>–ó–∞–Ω—è—Ç–æ</span>
                    </div>
                </div>
                
                <div id="bookingSummary" class="booking-summary" style="display: none;">
                    <p><strong>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞:</strong> <span id="selectedSeatsText"></span></p>
                    <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> <span id="totalPriceText"></span> ‚ÇΩ</p>
                </div>
                
                <div class="booking-actions">
                    <button id="confirmBookingBtn" onclick="confirmBooking()" class="action-button" disabled>
                        <span>‚úÖ</span>
                        <span>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
                    </button>
                    <button onclick="closeBookingModal()" class="action-button" style="background: rgba(244, 67, 54, 0.3); border-color: rgba(244, 67, 54, 0.5);">
                        <span>‚ùå</span>
                        <span>–û—Ç–º–µ–Ω–∞</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('home')">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
            </div>
            <div class="nav-item" onclick="showScreen('movies')">
                <span class="nav-icon">üé¨</span>
                <span class="nav-label">–§–∏–ª—å–º—ã</span>
            </div>
            <div class="nav-item" onclick="showScreen('sessions')">
                <span class="nav-icon">üïí</span>
                <span class="nav-label">–°–µ–∞–Ω—Å—ã</span>
            </div>
            <div class="nav-item" onclick="showScreen('login')">
                <span class="nav-icon">üë§</span>
                <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </div>
        </div>
    </div>

    <script>
        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ö–≠–®–ê –î–õ–Ø –†–ê–ó–†–ê–ë–û–¢–ö–ò - –£–°–ò–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        if ('caches' in window) {
            caches.keys().then(function(cacheNames) {
                cacheNames.forEach(function(cacheName) {
                    console.log('üóëÔ∏è –û–ß–ò–°–¢–ö–ê –ö–≠–®–ê:', cacheName);
                    caches.delete(cacheName);
                });
            });
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π
            const version = 'v1.2.2'; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            if (localStorage.getItem('appVersion') !== version) {
                localStorage.setItem('appVersion', version);
                window.location.reload(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –∫—ç—à–∞
                console.log('üîÑ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï: –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', version);
            }
        }
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_BASE = 'http://192.168.0.10:8000';
        let authToken = localStorage.getItem('token');
        let deferredPrompt;
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        let currentSession = null;
        let selectedSeats = [];
        let allSessions = [];

        // PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        document.getElementById('installButton').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showNotification('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                }
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            testConnection();
            updateAuthStatus(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            
            // –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ–∞–Ω—Å–∞—Ö
            console.log('üîç –í–†–ï–ú–ï–ù–ù–´–ô –¢–ï–°–¢ API: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ–∞–Ω—Å–∞—Ö...');
            makeAuthorizedRequest(`${API_BASE}/sessions`)
                .then(response => {
                    console.log('üì° API –û–¢–í–ï–¢ (–°–ï–ê–ù–°–´): –°—Ç–∞—Ç—É—Å:', response.status, '–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞:', response.statusText);
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ API –£–°–ü–ï–• (–°–ï–ê–ù–°–´): –î–∞–Ω–Ω—ã–µ –æ —Å–µ–∞–Ω—Å–∞—Ö –ø–æ–ª—É—á–µ–Ω—ã:', data.length, '—Å–µ–∞–Ω—Å–æ–≤');
                    if (data.length > 0) {
                        console.log('üîç –í–†–ï–ú–ï–ù–ù–´–ô –¢–ï–°–¢ API: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –±–∏–ª–µ—Ç–∞—Ö –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Å–µ–∞–Ω—Å–∞ ID:', data[0].id);
                        makeAuthorizedRequest(`${API_BASE}/sessions/${data[0].id}/tickets`)
                            .then(ticketResponse => {
                                console.log('üì° API –û–¢–í–ï–¢ (–ë–ò–õ–ï–¢–´): –°—Ç–∞—Ç—É—Å:', ticketResponse.status, '–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞:', ticketResponse.statusText);
                                if (!ticketResponse.ok) {
                                    throw new Error(`–û—à–∏–±–∫–∞ API –±–∏–ª–µ—Ç–æ–≤: ${ticketResponse.status} ${ticketResponse.statusText}`);
                                }
                                return ticketResponse.json();
                            })
                            .then(tickets => {
                                console.log('‚úÖ API –£–°–ü–ï–• (–ë–ò–õ–ï–¢–´): –î–∞–Ω–Ω—ã–µ –æ –±–∏–ª–µ—Ç–∞—Ö –ø–æ–ª—É—á–µ–Ω—ã:', tickets);
                            })
                            .catch(ticketError => {
                                console.error('‚ùå API –û–®–ò–ë–ö–ê (–ë–ò–õ–ï–¢–´):', ticketError.message);
                            });
                    }
                })
                .catch(error => {
                    console.error('‚ùå API –û–®–ò–ë–ö–ê (–°–ï–ê–ù–°–´):', error.message);
                });
            
            // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù Service Worker –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log('Service Worker –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏');
            /*
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
                    .catch(err => console.log('‚ùå –û—à–∏–±–∫–∞ SW:', err));
            }
            */
        });

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            console.error('üö® –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–®–ò–ë–ö–ê:', event.error);
            console.error('üìÅ –§–∞–π–ª:', event.filename);
            console.error('üìç –°—Ç—Ä–æ–∫–∞:', event.lineno);
            console.error('üìç –ö–æ–ª–æ–Ω–∫–∞:', event.colno);
            console.error('üìÑ –°–æ–æ–±—â–µ–Ω–∏–µ:', event.message);
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏
        function showScreen(screenName) {
            console.log('üîÑ –ü–ï–†–ï–•–û–î: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω:', screenName);
            console.log('üîç DEBUG: event –æ–±—ä–µ–∫—Ç:', event);
            console.log('üîç DEBUG: event.target:', event && event.target);
            
            try {
                // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
                const targetScreen = document.getElementById(screenName + 'Screen');
                if (targetScreen) {
                    targetScreen.classList.add('active');
                    console.log('‚úÖ –≠–ö–†–ê–ù: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —ç–∫—Ä–∞–Ω', screenName + 'Screen');
                } else {
                    console.log('‚ùå –û–®–ò–ë–ö–ê: –≠–∫—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', screenName + 'Screen');
                }
                
                // –ù–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ
                const navItems = document.querySelectorAll('.nav-item');
                console.log('üîç DEBUG: –ù–∞–π–¥–µ–Ω–æ nav-item —ç–ª–µ–º–µ–Ω—Ç–æ–≤:', navItems.length);
                
                navItems.forEach((item, index) => {
                    const navLabels = ['home', 'movies', 'sessions', 'login'];
                    if (navLabels[index] === screenName) {
                        item.classList.add('active');
                        console.log('‚úÖ –ù–ê–í–ò–ì–ê–¶–ò–Ø: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏', index);
                    }
                });
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Ä–∞–Ω–∞
                switch(screenName) {
                    case 'movies':
                        loadMovies();
                        break;
                    case 'sessions':
                        loadSessions();
                        break;
                }
            } catch (error) {
                console.error('‚ùå –û–®–ò–ë–ö–ê –≤ showScreen:', error);
                console.error('üìç Stack trace:', error.stack);
            }
        }

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        async function makeAuthorizedRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers.Authorization = `Bearer ${token}`;
            }
            
            return fetch(url, {
                ...options,
                headers
            });
        }
        
        async function testConnection() {
            updateConnectionStatus('connecting');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                updateConnectionStatus('online');
                showNotification('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
            } catch (error) {
                updateConnectionStatus('offline');
                showNotification('‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            }
        }

        async function loadDemoData() {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/demo/populate`);
                const data = await response.json();
                
                showNotification('üé≠ –î–µ–º–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
            
            showLoading(false);
        }

        async function loadMovies() {
            showLoading(true);
            
            try {
                const response = await makeAuthorizedRequest(`${API_BASE}/movies`);
                const movies = await response.json();
                
                const container = document.getElementById('moviesContainer');
                container.innerHTML = '';
                
                movies.forEach(movie => {
                    const movieCard = document.createElement('div');
                    movieCard.className = 'movie-card';
                    movieCard.innerHTML = `
                        <div class="movie-title">${movie.title}</div>
                        <div class="movie-info">
                            ${movie.duration} –º–∏–Ω<br>
                            ‚≠ê ${movie.rating}/10<br>
                            ${movie.genre || '–î—Ä–∞–º–∞'}
                        </div>
                    `;
                    container.appendChild(movieCard);
                });
                
                showNotification(`üé¨ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${movies.length} —Ñ–∏–ª—å–º–æ–≤`, 'success');
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–æ–≤', 'error');
            }
            
            showLoading(false);
        }

        async function loadSessions() {
            showLoading(true);
            
            try {
                const response = await makeAuthorizedRequest(`${API_BASE}/sessions`);
                const sessions = await response.json();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                allSessions = sessions;
                
                const container = document.getElementById('sessionsContainer');
                container.innerHTML = '';
                
                sessions.forEach(session => {
                    const sessionCard = document.createElement('div');
                    sessionCard.className = 'feature-card';
                    const availableSeats = session.available_seats || 0;
                    const totalSeats = session.total_seats || session.hall?.capacity || 0;
                    const seatStatus = availableSeats > 0 ? 
                        `<p style="color: #4CAF50;">ü™ë –°–≤–æ–±–æ–¥–Ω–æ: ${availableSeats}/${totalSeats} –º–µ—Å—Ç</p>` :
                        `<p style="color: #f44336;">üö´ –ú–µ—Å—Ç –Ω–µ—Ç (${totalSeats} –º–µ—Å—Ç)</p>`;
                    
                    sessionCard.innerHTML = `
                        <h4>${session.movie?.title || '–§–∏–ª—å–º'}</h4>
                        <p>üïí ${new Date(session.start_time).toLocaleString('ru')}</p>
                        <p>üí∞ ${session.price} ‚ÇΩ</p>
                        <p>üé™ ${session.hall?.name || session.hall_id}</p>
                        ${seatStatus}
                    `;
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ
                    if (availableSeats > 0) {
                        const bookingButton = document.createElement('button');
                        bookingButton.className = 'action-button';
                        bookingButton.style.margin = '10px 0';
                        bookingButton.innerHTML = `
                            <span>üé´</span>
                            <span>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–∏–ª–µ—Ç</span>
                        `;
                        bookingButton.onclick = () => {
                            console.log('üñ±Ô∏è –ö–õ–ò–ö: –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–µ–∞–Ω—Å–∞ ID:', session.id);
                            openBookingModal(session.id);
                        };
                        sessionCard.appendChild(bookingButton);
                    } else {
                        const disabledButton = document.createElement('button');
                        disabledButton.className = 'action-button';
                        disabledButton.style.margin = '10px 0';
                        disabledButton.style.opacity = '0.5';
                        disabledButton.style.cursor = 'not-allowed';
                        disabledButton.disabled = true;
                        disabledButton.innerHTML = `
                            <span>üö´</span>
                            <span>–ú–µ—Å—Ç –Ω–µ—Ç</span>
                        `;
                        sessionCard.appendChild(disabledButton);
                    }
                    
                    container.appendChild(sessionCard);
                });
                
                showNotification(`üïí –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${sessions.length} —Å–µ–∞–Ω—Å–æ–≤`, 'success');
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∞–Ω—Å–æ–≤', 'error');
            }
            
            showLoading(false);
        }

        async function performLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!username || !password) {
        showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', 'error');
        return;
    }
    
    showLoading(true);
    
    try {
        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('password', password);

        const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            authToken = data.access_token;
            localStorage.setItem('token', authToken);
            
                    
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    try {
                        const userResponse = await makeAuthorizedRequest(`${API_BASE}/auth/me`);
                        const userData = await userResponse.json();
                        localStorage.setItem('user', JSON.stringify(userData));
                        
                        showNotification(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userData.username}! (${userData.role})`, 'success');
                    } catch (e) {
                        showNotification(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`, 'success');
                    }
                    
                    // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    updateAuthStatus();
                } else {
                    showNotification('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'error');
                }
            } catch (error) {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
            }
            
            showLoading(false);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthStatus() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const navProfileItem = document.querySelector('.nav-item:last-child .nav-label');
            
            if (token && user) {
                const userData = JSON.parse(user);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                navProfileItem.textContent = userData.username;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const appName = document.querySelector('.header h1');
                if (appName && !appName.querySelector('.auth-indicator')) {
                    const authIndicator = document.createElement('span');
                    authIndicator.className = 'auth-indicator';
                    authIndicator.innerHTML = ` <span style="color: #4CAF50;">‚óè</span>`;
                    authIndicator.title = `${userData.username} (${userData.role})`;
                    appName.appendChild(authIndicator);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ª–æ–≥–∏–Ω–∞
                const loginScreen = document.getElementById('loginScreen');
                let welcomeMessage = loginScreen.querySelector('.welcome-message');
                if (!welcomeMessage) {
                    welcomeMessage = document.createElement('div');
                    welcomeMessage.className = 'welcome-message';
                    loginScreen.insertBefore(welcomeMessage, loginScreen.firstChild);
                }
                welcomeMessage.innerHTML = `
                    <div class="feature-card" style="background: rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.5);">
                        <h3>‚úÖ –í—ã –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!</h3>
                        <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${userData.username}</p>
                        <p><strong>–†–æ–ª—å:</strong> ${userData.role}</p>
                        <p><strong>Email:</strong> ${userData.email}</p>
                    </div>
                `;
                
                console.log('–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', userData.username, userData.role);
            } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                navProfileItem.textContent = '–ü—Ä–æ—Ñ–∏–ª—å';
                
                // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const authIndicator = document.querySelector('.auth-indicator');
                if (authIndicator) {
                    authIndicator.remove();
                }
                
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            authToken = null;
            showNotification('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
            updateAuthStatus();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status status-${status}`;
            
            switch(status) {
                case 'online':
                    statusElement.innerHTML = '<span>‚úÖ</span><span>–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>';
                    break;
                case 'offline':
                    statusElement.innerHTML = '<span>‚ùå</span><span>–ù–µ—Ç —Å–≤—è–∑–∏</span>';
                    break;
                case 'connecting':
                    statusElement.innerHTML = '<span>üîÑ</span><span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>';
                    break;
            }
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showMovies() {
            showScreen('movies');
        }

        function showSessions() {
            showScreen('sessions');
        }

        function showLogin() {
            showScreen('login');
        }

        function testAuthCompat() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token) {
                showNotification('‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', 'error');
                return;
            }
            
            showLoading(true);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ API
            makeAuthorizedRequest(`${API_BASE}/auth/me`)
                .then(response => response.json())
                .then(userData => {
                    showNotification(`‚úÖ –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userData.username} (${userData.role})`, 'success');
                    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    localStorage.setItem('user', JSON.stringify(userData));
                })
                .catch(error => {
                    showNotification('‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫', 'error');
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
                    
                    // –û—á–∏—â–∞–µ–º –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    authToken = null;
                })
                .finally(() => {
                    showLoading(false);
                });
        }

        // === –§–£–ù–ö–¶–ò–ò –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø –ë–ò–õ–ï–¢–û–í ===
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function openBookingModal(sessionId) {
            console.log('üé´ –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è openBookingModal –≤—ã–∑–≤–∞–Ω–∞ —Å sessionId:', sessionId);
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('‚ùå –î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                showScreen('login');
                return;
            }
            if (allSessions.length === 0) {
                await loadSessionsData();
            }
            currentSession = allSessions.find(s => s.id === sessionId);
            if (!currentSession) {
                showNotification('‚ùå –°–µ–∞–Ω—Å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            document.getElementById('bookingSessionInfo').innerHTML = `
                <h4>${currentSession.movie?.title || '–§–∏–ª—å–º'}</h4>
                <p>üïí ${new Date(currentSession.start_time).toLocaleString('ru')}</p>
                <p>üí∞ ${currentSession.price} ‚ÇΩ –∑–∞ –º–µ—Å—Ç–æ</p>
                <p>üé™ ${currentSession.hall?.name || `–ó–∞–ª ${currentSession.hall_id}`}</p>
            `;
            let occupiedSeats = [];
            try {
                const response = await makeAuthorizedRequest(`${API_BASE}/sessions/${currentSession.id}/tickets`);
                if (response.ok) {
                    const tickets = await response.json();
                    occupiedSeats = tickets.map(t => Number(t.seat_number));
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–Ω—è—Ç—ã—Ö –º–µ—Å—Ç:', e);
            }
            generateSeatMap(occupiedSeats);
            const modal = document.getElementById('bookingModal');
            modal.style.display = 'flex';
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞
        function toggleSeat(seatNumber) {
            const seatButton = document.querySelector(`[data-seat="${seatNumber}"]`);
            
            if (selectedSeats.includes(seatNumber)) {
                // –£–±–∏—Ä–∞–µ–º –º–µ—Å—Ç–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
                selectedSeats = selectedSeats.filter(s => s !== seatNumber);
                seatButton.classList.remove('selected');
                seatButton.classList.add('free');
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                selectedSeats.push(seatNumber);
                seatButton.classList.remove('free');
                seatButton.classList.add('selected');
            }
            
            updateBookingSummary();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function updateBookingSummary() {
            const summaryDiv = document.getElementById('bookingSummary');
            const confirmBtn = document.getElementById('confirmBookingBtn');
            
            if (selectedSeats.length === 0) {
                summaryDiv.style.display = 'none';
                confirmBtn.disabled = true;
                return;
            }
            
            const totalPrice = selectedSeats.length * currentSession.price;
            
            document.getElementById('selectedSeatsText').textContent = selectedSeats.sort((a, b) => a - b).join(', ');
            document.getElementById('totalPriceText').textContent = totalPrice;
            
            summaryDiv.style.display = 'block';
            confirmBtn.disabled = false;
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function confirmBooking() {
            if (!currentSession || selectedSeats.length === 0) {
                showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Å—Ç –ø–µ—Ä–µ–¥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                const responseCheck = await makeAuthorizedRequest(`${API_BASE}/sessions/${currentSession.id}/tickets`);
                console.log('üì° –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò: –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –æ—Ç API:', responseCheck.status, '–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞:', responseCheck.statusText);
                if (!responseCheck.ok) {
                    const checkErrorText = await responseCheck.text();
                    throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç: ${responseCheck.status} ${responseCheck.statusText}. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${checkErrorText}`);
                }
                const tickets = await responseCheck.json();
                const occupiedSeats = tickets.map(ticket => ticket.seat_number);
                const unavailableSeats = selectedSeats.filter(seat => occupiedSeats.includes(seat));
                
                if (unavailableSeats.length > 0) {
                    showNotification(`‚ùå –ú–µ—Å—Ç–∞ ${unavailableSeats.join(', ')} —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã`, 'error');
                    showLoading(false);
                    return;
                }
                
                const bookingData = {
                    session_id: currentSession.id,
                    seat_numbers: selectedSeats,
                    total_price: selectedSeats.length * currentSession.price
                };
                console.log('üì§ –û–¢–ü–†–ê–í–ö–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø: –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', bookingData);
                const response = await makeAuthorizedRequest(`${API_BASE}/tickets`, {
                    method: 'POST',
                    body: JSON.stringify(bookingData)
                });
                console.log('üì° –û–¢–í–ï–¢ –ù–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–ï: –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –æ—Ç API:', response.status, '–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞:', response.statusText);
                
                if (response.ok) {
                    const booking = await response.json();
                    showNotification(`üéâ –ë–∏–ª–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω! –ú–µ—Å—Ç–∞: ${selectedSeats.join(', ')}, –°—É–º–º–∞: ${selectedSeats.length * currentSession.price} ‚ÇΩ`, 'success');
                    closeBookingModal();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ–∞–Ω—Å–æ–≤
                    if (document.getElementById('sessionsScreen').classList.contains('active')) {
                        loadSessions();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå –û–®–ò–ë–ö–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø: –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—à–∏–±–∫–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    showNotification(`‚ùå –û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${errorText || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå –û–®–ò–ë–ö–ê –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø: –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º:', error.message);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message, 'error');
            }
            
            showLoading(false);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadSessionsData() {
            try {
                const response = await makeAuthorizedRequest(`${API_BASE}/sessions`);
                allSessions = await response.json();
            } catch (error) {
                console.error('Error loading sessions data:', error);
                allSessions = [];
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã –º–µ—Å—Ç
        function generateSeatMap(occupiedSeats = []) {
            const seatMapContainer = document.getElementById('seatMap');
            seatMapContainer.innerHTML = '';
            if (!currentSession) {
                seatMapContainer.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º—ã –º–µ—Å—Ç</p>';
                return;
            }
            const hall = currentSession.hall || { name: `–ó–∞–ª ${currentSession.hall_id || 1}`, capacity: currentSession.total_seats || 100 };
            const totalSeats = currentSession.total_seats || hall.capacity || 100;
            const rows = Math.ceil(totalSeats / 10);
            const seatsPerRow = Math.ceil(totalSeats / rows);
            for (let row = 1; row <= rows; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seat-row';
                const rowNumber = document.createElement('div');
                rowNumber.className = 'row-number';
                rowNumber.textContent = row;
                rowDiv.appendChild(rowNumber);
                for (let seat = 1; seat <= seatsPerRow; seat++) {
                    const seatNumber = (row - 1) * seatsPerRow + seat;
                    if (seatNumber > totalSeats) break;
                    const seatButton = document.createElement('button');
                    seatButton.className = 'seat';
                    seatButton.textContent = seatNumber;
                    seatButton.setAttribute('data-seat', seatNumber);
                    if (occupiedSeats.includes(seatNumber)) {
                        seatButton.classList.add('occupied');
                        seatButton.disabled = true;
                        seatButton.style.background = '#f44336';
                        seatButton.style.color = 'white';
                        seatButton.title = '–ó–∞–Ω—è—Ç–æ';
                    } else {
                        seatButton.classList.add('free');
                        seatButton.onclick = () => {
                            toggleSeat(seatNumber);
                        };
                    }
                    rowDiv.appendChild(seatButton);
                }
                seatMapContainer.appendChild(rowDiv);
            }
            updateBookingSummary(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–≤–æ–¥–∫—É –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            console.log(`‚úÖ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê: –°–æ–∑–¥–∞–Ω–æ ${rows} —Ä—è–¥–æ–≤ —Å ${seatsPerRow} –º–µ—Å—Ç–∞–º–∏`);
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            currentSession = null;
            selectedSeats = [];
            updateBookingSummary();
        }
    </script>
</body>
</html> 