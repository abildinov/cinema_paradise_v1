# Cinema API - Архитектура системы

## 📋 Обзор проекта

Cinema API - это полнофункциональная система управления кинотеатром, построенная на современных технологиях Python с использованием FastAPI фреймворка. Система предоставляет REST API для управления фильмами, кинотеатрами, сеансами, билетами и отзывами.

## 🏗 Архитектура системы

### Общая архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Client    │    │  Mobile Client  │    │   Admin Panel   │
│                 │    │                 │    │                 │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │      Load Balancer       │
                    │       (Nginx)            │
                    └─────────────┬─────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │     FastAPI Application   │
                    │                          │
                    │  ┌─────────────────────┐ │
                    │  │   Authentication    │ │
                    │  │      Service        │ │
                    │  └─────────────────────┘ │
                    │                          │
                    │  ┌─────────────────────┐ │
                    │  │    Business Logic   │ │
                    │  │     (Routers)       │ │
                    │  └─────────────────────┘ │
                    │                          │
                    │  ┌─────────────────────┐ │
                    │  │   Data Access       │ │
                    │  │   (SQLAlchemy)      │ │
                    │  └─────────────────────┘ │
                    └─────────────┬─────────────┘
                                 │
                    ┌─────────────▼─────────────┐
                    │    PostgreSQL Database    │
                    │                          │
                    │  ┌─────────────────────┐ │
                    │  │     Master DB       │ │
                    │  └─────────────────────┘ │
                    │                          │
                    │  ┌─────────────────────┐ │
                    │  │    Read Replicas    │ │
                    │  └─────────────────────┘ │
                    └───────────────────────────┘
```

### Компонентная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                    Cinema API Application                    │
├─────────────────────────────────────────────────────────────┤
│  Authentication Layer                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │     JWT     │  │   OAuth2    │  │   Session   │        │
│  │   Handler   │  │  Handler    │  │  Manager    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  API Layer (FastAPI Routers)                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Movies    │  │   Cinemas   │  │   Sessions  │        │
│  │   Router    │  │   Router    │  │   Router    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Tickets   │  │   Reviews   │  │    Users    │        │
│  │   Router    │  │   Router    │  │   Router    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  Business Logic Layer                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Booking   │  │  Validation │  │  Notification│       │
│  │   Service   │  │   Service   │  │   Service   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  Data Access Layer (SQLAlchemy)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Models    │  │   Schemas   │  │  Database   │        │
│  │             │  │             │  │   Config    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 🗄 Структура базы данных

### ER-диаграмма

```
┌─────────────────────┐         ┌─────────────────────┐
│        Users        │         │       Cinemas       │
├─────────────────────┤         ├─────────────────────┤
│ id (PK)            │         │ id (PK)            │
│ username           │         │ name               │
│ email              │         │ address            │
│ hashed_password    │         │ city               │
│ first_name         │         │ phone              │
│ last_name          │         │ email              │
│ phone              │         │ latitude           │
│ role               │         │ longitude          │
│ is_active          │         │ opening_time       │
│ loyalty_points     │         │ closing_time       │
│ total_spent        │         │ is_active          │
│ created_at         │         │ created_at         │
│ updated_at         │         │ updated_at         │
└─────────────────────┘         └─────────────────────┘
           │                              │
           │                              │
           │                              ▼
           │                    ┌─────────────────────┐
           │                    │        Halls        │
           │                    ├─────────────────────┤
           │                    │ id (PK)            │
           │                    │ cinema_id (FK)     │
           │                    │ name               │
           │                    │ hall_number        │
           │                    │ total_seats        │
           │                    │ rows               │
           │                    │ seats_per_row      │
           │                    │ screen_type        │
           │                    │ sound_system       │
           │                    │ vip_seats          │
           │                    │ premium_seats      │
           │                    │ standard_seats     │
           │                    │ is_active          │
           │                    │ created_at         │
           │                    │ updated_at         │
           │                    └─────────────────────┘
           │                              │
           │                              │
           ▼                              │
┌─────────────────────┐                   │
│       Movies        │                   │
├─────────────────────┤                   │
│ id (PK)            │                   │
│ title              │                   │
│ original_title     │                   │
│ description        │                   │
│ duration_minutes   │                   │
│ genre              │                   │
│ director           │                   │
│ producer           │                   │
│ cast               │                   │
│ release_year       │                   │
│ rating             │                   │
│ imdb_rating        │                   │
│ budget             │                   │
│ poster_url         │                   │
│ trailer_url        │                   │
│ is_active          │                   │
│ created_at         │                   │
│ updated_at         │                   │
└─────────────────────┘                   │
           │                              │
           └──────────────┐               │
                         │               │
                         ▼               ▼
                ┌─────────────────────┐
                │      Sessions       │
                ├─────────────────────┤
                │ id (PK)            │
                │ movie_id (FK)      │
                │ hall_id (FK)       │
                │ start_time         │
                │ end_time           │
                │ base_price         │
                │ vip_price          │
                │ premium_price      │
                │ available_seats    │
                │ sold_tickets       │
                │ language           │
                │ subtitles          │
                │ format_3d          │
                │ format_imax        │
                │ is_active          │
                │ created_at         │
                │ updated_at         │
                └─────────────────────┘
                         │
                         │
                         ▼
                ┌─────────────────────┐
                │       Tickets       │
                ├─────────────────────┤
                │ id (PK)            │
                │ session_id (FK)    │
                │ user_id (FK)       │
                │ seat_row           │
                │ seat_number        │
                │ seat_type          │
                │ price              │
                │ final_price        │
                │ booking_reference  │
                │ status             │
                │ payment_method     │
                │ qr_code            │
                │ is_paid            │
                │ booking_time       │
                │ created_at         │
                └─────────────────────┘
                         ▲
                         │
                         │
┌─────────────────────┐  │
│       Reviews       │  │
├─────────────────────┤  │
│ id (PK)            │  │
│ movie_id (FK)      │  │
│ user_id (FK)       │──┘
│ rating             │
│ title              │
│ content            │
│ is_spoiler         │
│ is_verified_purchase│
│ helpful_votes      │
│ unhelpful_votes    │
│ is_approved        │
│ created_at         │
│ updated_at         │
└─────────────────────┘
```

### Описание таблиц

#### 1. Users (Пользователи)
Хранит информацию о пользователях системы с различными ролями
- **25 полей**: ID, аутентификация, личные данные, роли, статистика
- **Связи**: One-to-Many с Tickets и Reviews

#### 2. Movies (Фильмы)
Каталог фильмов с подробной информацией
- **24 поля**: Основная информация, метаданные, рейтинги, URL ресурсов
- **Связи**: One-to-Many с Sessions и Reviews

#### 3. Cinemas (Кинотеатры)
Сеть кинотеатров с геолокацией
- **15 полей**: Контактная информация, адрес, координаты, расписание
- **Связи**: One-to-Many с Halls

#### 4. Halls (Залы)
Залы кинотеатров с детальной конфигурацией
- **17 полей**: Конфигурация мест, техническое оснащение, типы мест
- **Связи**: Many-to-One с Cinemas, One-to-Many с Sessions

#### 5. Sessions (Сеансы)
Расписание показов фильмов
- **20 полей**: Время, цены, статус, технические параметры
- **Связи**: Many-to-One с Movies и Halls, One-to-Many с Tickets

#### 6. Tickets (Билеты)
Система бронирования билетов
- **18 полей**: Место, цена, статус, платежная информация
- **Связи**: Many-to-One с Sessions и Users

#### 7. Reviews (Отзывы)
Система отзывов и рейтингов
- **13 полей**: Рейтинг, текст, модерация, статистика голосов
- **Связи**: Many-to-One с Movies и Users

## 🎯 Use Case диаграмма

### Главный сценарий: Бронирование билета

```
┌─────────────────────────────────────────────────────────────┐
│                   Use Case: Бронирование билета             │
├─────────────────────────────────────────────────────────────┤
│                                                            │
│  Актор: Клиент                                             │
│                                                            │
│  Предусловия:                                              │
│  - Клиент зарегистрирован в системе                        │
│  - Клиент авторизован                                      │
│  - Есть доступные сеансы                                   │
│                                                            │
│  Основной сценарий:                                        │
│  1. Клиент открывает каталог фильмов                       │
│  2. Система отображает список активных фильмов             │
│  3. Клиент выбирает фильм                                  │
│  4. Система показывает доступные сеансы                    │
│  5. Клиент выбирает подходящий сеанс                       │
│  6. Система отображает схему зала и свободные места        │
│  7. Клиент выбирает места                                  │
│  8. Система рассчитывает стоимость                         │
│  9. Клиент подтверждает бронирование                       │
│  10. Система создает билет с уникальным номером            │
│  11. Система отправляет подтверждение на email             │
│  12. Система обновляет количество доступных мест           │
│                                                            │
│  Альтернативные сценарии:                                  │
│  - Место занято другим клиентом (блокировка на время)      │
│  - Недостаточно средств на счете                           │
│  - Сеанс отменен или перенесен                             │
│                                                            │
│  Постусловия:                                              │
│  - Билет забронирован                                      │
│  - Место недоступно для других клиентов                    │
│  - Клиент получил подтверждение                            │
│                                                            │
└─────────────────────────────────────────────────────────────┘
```

### Диаграмма последовательности

```
Клиент    →    Frontend    →    API Gateway    →    Cinema API    →    Database
  │                │                 │                │                 │
  │   Выбор фильма │                 │                │                 │
  ├────────────────►                 │                │                 │
  │                │   GET /movies   │                │                 │
  │                ├─────────────────►                │                 │
  │                │                 │  GET /movies   │                 │
  │                │                 ├────────────────►                 │
  │                │                 │                │ SELECT movies   │
  │                │                 │                ├─────────────────►
  │                │                 │                │   ← movies      │
  │                │                 │                ◄─────────────────┤
  │                │                 │ ← movies     │                 │
  │                │                 ◄────────────────┤                 │
  │                │   ← movies      │                │                 │
  │                ◄─────────────────┤                │                 │
  │   ← фильмы     │                 │                │                 │
  ◄────────────────┤                 │                │                 │
  │                │                 │                │                 │
  │ Выбор сеанса   │                 │                │                 │
  ├────────────────►                 │                │                 │
  │                │ GET /sessions   │                │                 │
  │                ├─────────────────►                │                 │
  │                │                 │ GET /sessions  │                 │
  │                │                 ├────────────────►                 │
  │                │                 │                │SELECT sessions  │
  │                │                 │                ├─────────────────►
  │                │                 │                │ ← sessions      │
  │                │                 │                ◄─────────────────┤
  │                │                 │ ← sessions     │                 │
  │                │                 ◄────────────────┤                 │
  │                │ ← sessions      │                │                 │
  │                ◄─────────────────┤                │                 │
  │ ← сеансы       │                 │                │                 │
  ◄────────────────┤                 │                │                 │
  │                │                 │                │                 │
  │ Бронирование   │                 │                │                 │
  ├────────────────►                 │                │                 │
  │                │ POST /tickets   │                │                 │
  │                ├─────────────────►                │                 │
  │                │                 │POST /tickets   │                 │
  │                │                 ├────────────────►                 │
  │                │                 │                │ BEGIN TRANSACTION│
  │                │                 │                ├─────────────────►
  │                │                 │                │ INSERT ticket   │
  │                │                 │                ├─────────────────►
  │                │                 │                │ UPDATE session  │
  │                │                 │                ├─────────────────►
  │                │                 │                │ COMMIT          │
  │                │                 │                ├─────────────────►
  │                │                 │                │ ← ticket        │
  │                │                 │                ◄─────────────────┤
  │                │                 │ ← ticket       │                 │
  │                │                 ◄────────────────┤                 │
  │                │ ← билет         │                │                 │
  │                ◄─────────────────┤                │                 │
  │ ← подтверждение│                 │                │                 │
  ◄────────────────┤                 │                │                 │
```

## 🔧 REST API Endpoints

### Аутентификация
- `POST /api/v1/auth/register` - Регистрация пользователя
- `POST /api/v1/auth/login` - Авторизация и получение JWT токена
- `GET /api/v1/auth/me` - Получение профиля текущего пользователя
- `GET /api/v1/auth/users` - Список пользователей (админ)

### Фильмы
- `GET /api/v1/movies` - Список фильмов с фильтрацией
- `POST /api/v1/movies` - Создание фильма (админ)
- `GET /api/v1/movies/{id}` - Получение фильма по ID
- `PUT /api/v1/movies/{id}` - Обновление фильма (админ)
- `DELETE /api/v1/movies/{id}` - Удаление фильма (админ)
- `GET /api/v1/movies/{id}/sessions` - Сеансы фильма

### Кинотеатры
- `GET /api/v1/cinemas` - Список кинотеатров
- `POST /api/v1/cinemas` - Создание кинотеатра (админ)
- `GET /api/v1/cinemas/{id}` - Получение кинотеатра по ID
- `GET /api/v1/cinemas/{id}/halls` - Залы кинотеатра
- `POST /api/v1/cinemas/{id}/halls` - Создание зала (админ)
- `GET /api/v1/cinemas/search` - Поиск кинотеатров по геолокации

### Сеансы
- `GET /api/v1/sessions` - Список сеансов с фильтрацией
- `POST /api/v1/sessions` - Создание сеанса (админ)
- `GET /api/v1/sessions/{id}` - Получение сеанса по ID
- `PUT /api/v1/sessions/{id}` - Обновление сеанса (админ)
- `DELETE /api/v1/sessions/{id}` - Удаление сеанса (админ)
- `GET /api/v1/sessions/{id}/available-seats` - Доступные места

### Билеты
- `POST /api/v1/tickets` - Бронирование билета
- `GET /api/v1/tickets` - Список билетов с фильтрацией
- `GET /api/v1/tickets/{id}` - Получение билета по ID
- `PUT /api/v1/tickets/{id}` - Обновление билета
- `DELETE /api/v1/tickets/{id}` - Отмена бронирования
- `PATCH /api/v1/tickets/{id}/pay` - Оплата билета
- `GET /api/v1/tickets/statistics` - Статистика по билетам

### Отзывы
- `POST /api/v1/reviews` - Создание отзыва
- `GET /api/v1/reviews/movie/{id}` - Отзывы о фильме
- `GET /api/v1/reviews/{id}` - Получение отзыва по ID
- `PUT /api/v1/reviews/{id}` - Обновление отзыва
- `DELETE /api/v1/reviews/{id}` - Удаление отзыва
- `POST /api/v1/reviews/{id}/vote` - Голосование за отзыв
- `GET /api/v1/reviews/user/my-reviews` - Мои отзывы

## 🔐 Безопасность

### Аутентификация и авторизация
- **JWT токены** с истечением срока действия
- **Роли пользователей**: Customer, Manager, Admin
- **Хеширование паролей** с использованием bcrypt
- **Bearer токен** в заголовках запросов

### Валидация данных
- **Pydantic модели** для валидации входных данных
- **SQLAlchemy модели** с ограничениями на уровне БД
- **Email валидация** для регистрации
- **Санитизация** пользовательского ввода

## 🚀 Развертывание

### Локальная разработка
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск с автоперезагрузкой
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Docker контейнеры
```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### VPS развертывание
1. **Подготовка сервера**: Ubuntu 20.04 LTS
2. **Установка Docker** и Docker Compose
3. **Настройка PostgreSQL** с репликацией
4. **Nginx** как reverse proxy
5. **SSL сертификаты** (Let's Encrypt)
6. **Мониторинг** (Prometheus + Grafana)

## 📊 Мониторинг и логирование

### Метрики
- Количество запросов в секунду
- Время ответа API
- Ошибки и их типы
- Загрузка базы данных
- Статистика бронирований

### Логирование
- Структурированные логи в JSON
- Уровни: DEBUG, INFO, WARNING, ERROR
- Ротация логов по размеру
- Централизованный сбор логов

## 🎯 Масштабирование

### Горизонтальное масштабирование
- **Load Balancer** (Nginx/HAProxy)
- **Множественные инстансы** FastAPI
- **Кеширование** (Redis)
- **CDN** для статических файлов

### Вертикальное масштабирование
- **Оптимизация запросов** к БД
- **Индексы** в PostgreSQL
- **Connection pooling**
- **Кеширование результатов**

## 🔄 CI/CD Pipeline

```yaml
# GitHub Actions example
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run tests
        run: pytest
      
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to VPS
        run: |
          # Deployment commands
```

## 📈 Будущие улучшения

### Функциональные
- Система лояльности клиентов
- Интеграция с платежными системами
- Мобильные приложения (React Native/Flutter)
- Уведомления (email, SMS, push)
- Аналитика и отчетность

### Технические
- Микросервисная архитектура
- Event-driven architecture
- GraphQL API
- WebSocket для real-time обновлений
- Машинное обучение для рекомендаций 